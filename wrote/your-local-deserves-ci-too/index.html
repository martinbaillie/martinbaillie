<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Martin Baillie | Your Local Deserves CI, too</title><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><link rel=canonical href=https://martin.baillie.id/wrote/your-local-deserves-ci-too/><meta property="og:title" content="Martin Baillie | Your Local Deserves CI, too"><meta name=description content="Nix Early last year, after teetering on the edge for a while, I finally took the plunge into the world of Nix. It always seemed to be the logical conclusion to my declarative over imperative leanings and it has not disappointed.
I would classify myself as a semi-retired OS bikeshedder these days. I no longer obsess over ricing my prompt nor switch tiling WMs like they&rsquo;re going out of style. Instead, my prompt is a simple exit code coloured semi-colon and I spend the majority of time in either Firefox or Emacs (+vterm)."><meta property="og:image" content="https://martin.baillie.id//img/me.jpg"><meta itemprop=name content="Martin Baillie | Your Local Deserves CI, too"><meta name=application-name content="Martin Baillie"><meta property="og:site_name" content="Martin Baillie"><meta property="og:title" content="Your Local Deserves CI, too"><meta property="og:description" content="Nix Early last year, after teetering on the edge for a while, I finally took the plunge into the world of Nix. It always seemed to be the logical conclusion to my declarative over imperative leanings and it has not disappointed.
I would classify myself as a semi-retired OS bikeshedder these days. I no longer obsess over ricing my prompt nor switch tiling WMs like they&rsquo;re going out of style. Instead, my prompt is a simple exit code coloured semi-colon and I spend the majority of time in either Firefox or Emacs (+vterm)."><meta property="og:type" content="article"><meta property="og:url" content="https://martin.baillie.id/wrote/your-local-deserves-ci-too/"><meta property="article:published_time" content="2020-06-06T00:00:00+10:00"><meta property="article:modified_time" content="2020-06-06T00:00:00+10:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Your Local Deserves CI, too"><meta name=twitter:description content="Nix Early last year, after teetering on the edge for a while, I finally took the plunge into the world of Nix. It always seemed to be the logical conclusion to my declarative over imperative leanings and it has not disappointed.
I would classify myself as a semi-retired OS bikeshedder these days. I no longer obsess over ricing my prompt nor switch tiling WMs like they&rsquo;re going out of style. Instead, my prompt is a simple exit code coloured semi-colon and I spend the majority of time in either Firefox or Emacs (+vterm)."><meta name=twitter:site content="@martinbaillie"><meta name=twitter:creator content="@martinbaillie"><meta name=twitter:image content="https://martin.baillie.id//img/me.jpg"><link rel=apple-touch-icon sizes=57x57 href=/img/favicon/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/img/favicon/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/img/favicon/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/img/favicon/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/img/favicon/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/img/favicon/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/img/favicon/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/img/favicon/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/img/favicon/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/img/favicon/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=/img/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/img/favicon/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/img/favicon/favicon-16x16.png><link rel=manifest href=/img/favicon/manifest.json><meta name=msapplication-TileImage content="/img/favicon/ms-icon-144x144.png"><meta name=msapplication-TileColor content="#ffffff"><meta name=theme-color content="#ffffff"><script>if(localStorage.theme)document.documentElement.setAttribute("data-theme",localStorage.theme);</script><link rel="stylesheet preload prefetch" as=style type=text/css media=screen href=https://martin.baillie.id/main.1a92a966a2a8f7588c617b795cff11e8b0e38fca99a44048a51198066a1894610096b89c16e109d9f38f37ebe4e9db238df38d7f190459089474dbe9c7d02cb3.css integrity="sha512-GpKpZqKo91iMYXt5XP8R6LDjj8qZpEBIpRGYBmoYlGEAlricFuEJ2fOPN+vk6dsjjfONfxkEWQiUdNvpx9Assw==" crossorigin=anonymous></head><body><div class=content><header><div class=main><a href=https://martin.baillie.id/>Martin Baillie</a></div><nav><a class=soc id=tags href=/tags title=Tags><i data-feather=tag></i></a><a class=soc id=feed href=/index.xml title="RSS Feed"><i data-feather=rss></i></a><a class=soc id=mode href=javascript:toggleMode(); title="Switch Theme"><i data-feather=moon></i></a></nav></header><main><article><div class=title><h1>Your Local Deserves CI, too</h1></div><div class=meta><div class=posted><i data-feather=edit-3></i>20200606</div><div class=reading><i data-feather=clock></i>~07 mins</div></div><div class=tldr><strong>tl;dr:</strong>
Build your local Nix environments using free CI.</div><section class=body><div class=single><h2 id=nix>Nix</h2><p>Early last year, after teetering on the edge for a while, I finally took the
plunge into the world of <a href=https://nixos.org>Nix</a>. It always seemed to be the logical conclusion to
my declarative over imperative leanings and it has not disappointed.</p><p>I would classify myself as a semi-retired OS <a href=https://en.wiktionary.org/wiki/bikeshedding>bikeshedder</a> these days. I no longer
obsess over <a href=https://old.reddit.com/r/unixporn/wiki/themeing/dictionary#wiki%5Frice>ricing</a> my prompt nor switch tiling WMs like they&rsquo;re going out of
style. Instead, my prompt is a simple exit code coloured semi-colon and I spend
the majority of time in either Firefox or Emacs (+vterm). On NixOS I am using
the Sway Wayland compositor and on macOS I am usually just running native
fullscreen, ⌘↹ing between the two previously mentioned apps.</p><p>All in, this means my recent <a href=https://github.com/martinbaillie/dotfiles>dotfiles</a> are much less sprawling than they have
been in the past and were therefore easy to convert to Nix expressions.</p><p>The expressions are organised into platform-agnostic &ldquo;modules&rdquo; that leverage the
likes of the <a href=https://github.com/nixos/nixpkgs>nixpkgs</a>, <a href=https://github.com/nix-community/home-manager>home-manager</a> and <a href=https://github.com/LnL7/nix-darwin>nix-darwin</a> channels to fully configure
the OS and userspace from scratch.</p><p>On top of basic software provisioning Nix expressions, I&rsquo;ve written a simple
theming system that I use to switch various things between light and dark mode,
and a &ldquo;secrets&rdquo; attribute set (kept encrypted in a private repository) is used to
wire secrets throughout.</p><p>I&rsquo;m very happy with the result. The expressions work flawlessly between NixOS
and macOS, and I&rsquo;m able to go from fresh install to <em>mise en place</em> with the
flick of a <a href=https://github.com/martinbaillie/dotfiles/blob/master/Makefile><code>Makefile</code></a> target. I might try to find the time to convert my so-called
modules to proper boolean flagged, <a href=https://search.nixos.org/options>nixpkgs-styled options</a>, and the <a href=https://github.com/NixOS/rfcs/pull/49>Flakes RFC</a>
looks very promising and solves my main criticism of Nix, but otherwise I am
feeling pretty zen about it all with no immediate desire to touch things (for a
change!).</p><h2 id=continuous-integration>Continuous Integration</h2><p>Something I could not find many people doing, publicly at least, was building
their Nix dotfile repositories on push using the popular free CI services.</p><p>There are many ways to skin this cat but my approach was to build as native to
the target environment as I can get. Currently this looks like a combination of:</p><ul><li>GitHub Actions (macOS)</li></ul><p>GitHub Actions are great and have generous amounts of free macOS minutes on true
Apple hardware-based runners, so this was a no brainer.</p><ul><li>Travis CI (NixOS, by way of QEMU)</li></ul><p>Alas, GitHub do not provide access to underlying hardware virtualisation on
their SaaS Actions runners (at least at the time of writing this), and their
Linux runners are exclusively Ubuntu to boot. Since I really want to build a
NixOS VM to truly test every aspect of my expressions this means switching up to
Travis for these builds.</p><h3 id=building>Building</h3><p>My parlour trick for covering all bases is to generate a special CI machine that
imports every one of my modules:</p><div class=highlight><pre class=chroma><code class=language-nix data-lang=nix><span class=p>{</span> <span class=n>pkgs</span><span class=o>,</span> <span class=n>lib</span><span class=o>,</span> <span class=o>...</span> <span class=p>}:</span>
<span class=c1># For CI, import every module but select a single theme, ultimately testing both</span>
<span class=c1># themes over the course of the NixOS and macOS CI runs. Also filter out any</span>
<span class=c1># system specific modules that are not for the current system.</span>
<span class=k>let</span>
  <span class=k>inherit</span> <span class=p>(</span><span class=nb>builtins</span><span class=p>)</span> <span class=n>readDir</span> <span class=n>concatLists</span> <span class=n>filter</span> <span class=n>match</span><span class=p>;</span>
  <span class=k>inherit</span> <span class=p>(</span><span class=n>lib</span><span class=p>)</span> <span class=n>mapAttrsToList</span> <span class=n>hasSuffix</span><span class=p>;</span>
  <span class=k>inherit</span> <span class=p>(</span><span class=n>lib</span><span class=o>.</span><span class=n>systems</span><span class=o>.</span><span class=n>elaborate</span> <span class=p>{</span> <span class=n>system</span> <span class=o>=</span> <span class=nb>builtins</span><span class=o>.</span><span class=n>currentSystem</span><span class=p>;</span> <span class=p>})</span> <span class=n>isLinux</span><span class=p>;</span>
  <span class=n>nixFilesIn</span> <span class=o>=</span> <span class=n>dir</span><span class=p>:</span>
    <span class=k>let</span>
      <span class=n>children</span> <span class=o>=</span> <span class=n>readDir</span> <span class=n>dir</span><span class=p>;</span>
      <span class=n>f</span> <span class=o>=</span> <span class=n>path</span><span class=p>:</span> <span class=n>type</span><span class=p>:</span>
        <span class=k>let</span> <span class=n>absPath</span> <span class=o>=</span> <span class=n>dir</span> <span class=o>+</span> <span class=s2>&#34;/</span><span class=si>${</span><span class=n>path</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>;</span>
        <span class=k>in</span> <span class=k>if</span> <span class=n>type</span> <span class=o>==</span> <span class=s2>&#34;directory&#34;</span> <span class=k>then</span>
          <span class=n>nixFilesIn</span> <span class=n>absPath</span>
        <span class=k>else</span> <span class=k>if</span> <span class=n>hasSuffix</span> <span class=s2>&#34;.nix&#34;</span> <span class=p>(</span><span class=nb>baseNameOf</span> <span class=n>path</span><span class=p>)</span> <span class=k>then</span>
          <span class=p>[</span> <span class=n>absPath</span> <span class=p>]</span>
        <span class=k>else</span>
          <span class=p>[</span> <span class=p>];</span>
    <span class=k>in</span> <span class=n>concatLists</span> <span class=p>(</span><span class=n>mapAttrsToList</span> <span class=n>f</span> <span class=n>children</span><span class=p>);</span>
  <span class=n>modules</span> <span class=o>=</span> <span class=n>filter</span> <span class=p>(</span><span class=n>n</span><span class=p>:</span>
    <span class=n>match</span>
    <span class=p>(</span><span class=s2>&#34;(.*/themes/.*|.*.&#34;</span> <span class=o>+</span> <span class=p>(</span><span class=k>if</span> <span class=n>isLinux</span> <span class=k>then</span> <span class=s2>&#34;darwin&#34;</span> <span class=k>else</span> <span class=s2>&#34;linux&#34;</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34;.nix$)&#34;</span><span class=p>)</span>
    <span class=p>(</span><span class=nb>toString</span> <span class=n>n</span><span class=p>)</span> <span class=o>==</span> <span class=no>null</span><span class=p>)</span> <span class=p>(</span><span class=n>nixFilesIn</span> <span class=sr>&lt;modules&gt;</span><span class=p>);</span>
  <span class=n>theme</span> <span class=o>=</span> <span class=p>(</span><span class=k>if</span> <span class=n>isLinux</span> <span class=k>then</span> <span class=sr>&lt;modules/themes/light&gt;</span> <span class=k>else</span> <span class=sr>&lt;modules/themes/dark&gt;</span><span class=p>);</span>
<span class=k>in</span> <span class=p>{</span> <span class=n>imports</span> <span class=o>=</span> <span class=p>[</span> <span class=sr>../../.</span> <span class=n>theme</span> <span class=p>]</span> <span class=o>++</span> <span class=n>modules</span><span class=p>;</span> <span class=p>}</span>
</code></pre></div><p>Using this pseudo machine, I can derive either a NixOS VM (via QEMU) on Travis
or simply build on a fresh Darwin Actions runner VM (in the case of macOS). Over
the course of both builds combined, all my Nix expressions are exercised.</p><div class=highlight><pre class=chroma><code class=language-make data-lang=make><span class=c># CI targets.
</span><span class=c># $(GITHUB_ACTIONS) == true
</span><span class=c># $(TRAVIS) == true
</span><span class=c></span><span class=nf>ci</span><span class=o>:</span> <span class=n>dep</span> <span class=n>channels</span> <span class=n>update</span>
<span class=err>ifeq</span> <span class=err>(</span><span class=k>$(</span><span class=nv>SYSTEM</span><span class=k>)</span><span class=err>,Linux)</span>
	<span class=nv>NIX_PATH</span><span class=o>=</span><span class=k>$(</span>HOME<span class=k>)</span>/.nix-defexpr/channels<span class=nv>$$</span><span class=o>{</span>NIX_PATH:+:<span class=o>}</span><span class=k>$(</span>NIX_PATH<span class=k>)</span> <span class=se>\
</span><span class=se></span>	<span class=o>&amp;&amp;</span> <span class=k>$(</span>NIX_BUILD<span class=k>)</span> <span class=s1>&#39;&lt;nixpkgs/nixos&gt;&#39;</span> -A vm -k <span class=se>\
</span><span class=se></span>		-I nixos-config<span class=o>=</span><span class=k>$(</span>WORKDIR<span class=k>)</span>/machines/ci/vm.nix
<span class=err>else</span>
	<span class=err>if</span> <span class=err>test</span> <span class=err>-e</span> <span class=err>/etc/static/bashrc;</span> <span class=err>then</span> <span class=err>.</span> <span class=err>/etc/static/bashrc;</span> <span class=err>fi</span> <span class=err>\</span>
	<span class=err>&amp;&amp;</span> <span class=k>$(</span><span class=nv>MAKE</span><span class=k>)</span> <span class=err>test</span> <span class=nv>HOSTNAME</span><span class=o>=</span>ci
<span class=err>endif</span>
<span class=nf>.PHONY</span><span class=o>:</span> <span class=n>ci</span>
</code></pre></div><h3 id=caching>Caching</h3><p>The resultant binaries are pushed to Cachix and subsequently become available
for any of my other machines thus saving a lot of wasted CPU cycles!</p></div></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/nix>nix</a></li><li><a href=/tags/github>github</a></li></ul></nav></div></article></main><footer><hr><a class=soc href=https://github.com/martinbaillie title=GitHub><i data-feather=github></i></a><a class=soc href=https://linkedin.com/in/martinbaillie title=LinkedIn><i data-feather=linkedin></i></a><a class=soc href=https://twitter.com/martinbaillie title=Twitter><i data-feather=twitter></i></a><a class=soc href=mailto:martin@baillie.id title=Email><i data-feather=mail></i></a><a class=soc href=https://github.com/martinbaillie.gpg title="GPG Public Key">C2F0 79DE D64B 7361 006A A099 2A56 EA64 591E 15E4</a>
<a class=menu href=/id>$id</a>
<span class="active menu">fieldnotes</span></footer><script src=https://martin.baillie.id/main.973958f01e12093fe43ffa42a348051a785d30fce9de263597ea8b8f5dee989dd6a8aa74c4dc28b6e383f6e0e16be0710e3be747596d2765f496fa591784c803.js integrity="sha512-lzlY8B4SCT/kP/pCo0gFGnhdMPzp3iY1l+qLj13umJ3WqKp0xNwotuOD9uDha+BxDjvnR1ltJ2X0lvpZF4TIAw==" crossorigin=anonymous></script><script data-goatcounter=https://martinbaillie.goatcounter.com/count async src=//gc.zgo.at/count.js></script></div></body></html>